!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t.authllizer=t.authllizer||{},t.authllizer.core={}))}(this,function(t){"use strict";function e(t){return"object"==typeof t}function r(t){return void 0===t&&(t=1/0),function(n){void 0===n&&(n={});for(var o=[],i=1;i<arguments.length;i++)o[i-1]=arguments[i];for(var s=o.length,a=0;a<s;a++)for(var p=o[a]||{},u=Object.keys(p),c=u.length,h=0;h<c;h++){var f=u[h],l=p[f];t&&e(l)&&!Array.isArray(l)&&e(n[f])&&!Array.isArray(n[f])&&(l=r(--t)({},n[f],l)),n[f]=l}return n}}function n(t,e){function r(){this.constructor=t}m(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}function o(t){return function(e){function r(){for(var r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];var o=e.apply(this,r)||this;return _(o,t),o}return n(r,e),r}(this)}function i(t){return"string"==typeof t}function s(t){return void 0!==t&&null!==t}function a(t,e,r){if(!s(e)||""===e)return t;for(var n=(""+e).split("."),o=n.length,i=t,a=0;a<o;a++){var p=n[a];try{i=i[p]}catch(t){return r}}return void 0!==i?i:r}function p(t,e){if(/^(?:[a-z]+:)?\/\//i.test(e))return e;var r=[t,e].join("/");return function(t){return t.replace(/[\/]+/g,"/").replace(/\/\?/g,"?").replace(/\/\#/g,"#").replace(/\:\//g,"://")}(r)}function u(t,e){void 0===t&&(t=[]),void 0===e&&(e=function(t){return t});var r=!Array.isArray(t)&&Object.keys(t),n=(r||t).length;if(!n)return t;for(var o=0;o<n;){var i=r?r[o++]:o++;e(t[i],i,t)}return t}function c(t){void 0===t&&(t="");var e={};return u(t.split("&"),function(t){if(t){var r=t.split("="),n=decodeURIComponent(r[0]),o=!r[1]||decodeURIComponent(r[1]);e[n]=o}}),e}function h(t,e){var r=void 0===e?{}:e,n=r.path,o=r.data;if(i(t)){var s=document.createElement("a");s.href=t,t=s}var a=t.protocol,p=t.hostname,u=t.port,c=t.pathname,h=t.search,f=t.hash,l="https:"===a;return u=u||(l?"443":"80"),c="/"===c[0]?c:"/"+c,[a+"//"+p+":"+u,n?c:"",o?h+f:""].join("")}function f(t){return"function"==typeof t}function l(t){return e(t)&&t instanceof RegExp}function d(t){var e;if("undefined"!=typeof module&&module.exports)try{e=require("buffer").Buffer}catch(t){}var r=String.fromCharCode,n=new RegExp(["[À-ß][-¿]","[à-ï][-¿]{2}","[ð-÷][-¿]{3}"].join("|"),"g"),o=function(t){switch(t.length){case 4:var e=(7&t.charCodeAt(0))<<18|(63&t.charCodeAt(1))<<12|(63&t.charCodeAt(2))<<6|63&t.charCodeAt(3),n=e-65536;return r(55296+(n>>>10))+r(56320+(1023&n));case 3:return r((15&t.charCodeAt(0))<<12|(63&t.charCodeAt(1))<<6|63&t.charCodeAt(2));default:return r((31&t.charCodeAt(0))<<6|63&t.charCodeAt(1))}},i=function(t){return t.replace(n,o)};return(e?function(t){return(t.constructor===e.constructor?t:new e(t,"base64")).toString()}:function(t){return i(atob(t))})(String(t).replace(/[-_]/g,function(t){return"-"===t?"+":"/"}).replace(/[^A-Za-z0-9\+\/]/g,""))}function g(t,e){var r=void 0===e?{}:e,n=r.encode,o=void 0!==n&&n,i=r.delimiter,s=void 0===i?",":i,a=[];return u(t,function(t,e){o&&(e=encodeURIComponent(e),t=encodeURIComponent(t)),a.push(e+"="+t)}),a.join(s)}function y(t,r){if(!e(r)||!Object.keys(r).length)return t;var n=t.split("?"),o=n[0],i=n[1],s=void 0===i?"":i,a=c(s);return T(a,r),s=g(a,{encode:!0,delimiter:"&"}),o+"?"+s}function v(){return Math.random().toString(36).substr(2)}function k(t){return t.replace(/([\:\-\_\.]+(.))/g,function(t,e,r,n){return n?r.toUpperCase():r})}!function(t){t.signIn="signIn",t.signUp="signUp",t.signOut="signOut",t.authenticate="authenticate",t.link="link",t.unlink="unlink",t.refresh="refresh"}(t.AdapterRequestType||(t.AdapterRequestType={}));var _=r(),m=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},w=function(){function t(t){this.baseUrl="/auth",this.signIn="/signin",this.signOut="/signout",this.signUp="/signup",this.authenticate="",this.link="",this.unlink="/unlink",this.refresh="/refresh",this.defaultHttpOptions={method:"POST",data:{},params:{},headers:{},withCredentials:!1},this.providerInUrl=!0,this.tokenPath="access_token",this._httpClient=t}return t.prototype.request=function(t){var e=this,r=t.extractToken,n=this.getDefaultRouteOptions(t),o=this.prepareUrl(t,n),i=this.prepareOptions(t,n);return this._httpClient.request(o,i).then(function(t){var n={response:t};return r&&(n.token=e.extractToken(t)),n})},t.prototype.prepareUrl=function(t,e){var r=t.provider,n=e.url;return r&&this.providerInUrl&&(n=p(n,r)),this.baseUrl?p(this.baseUrl,n):n},t.prototype.prepareOptions=function(t,e){var r=t.token,n=t.provider,o=t.data,s=e.httpOptions,a=this,p=a.defaultHttpOptions,u=a.providerInUrl,c={data:{},params:{},headers:{}};n&&!u&&(o.provider=n),r&&(c.headers.Authorization=r.toHeader());var h=_({data:{},params:{},headers:{}},p,s,c);return h.method=i(h.method)?h.method.toUpperCase():"POST",this.prepareData(h,o)},t.prototype.getDefaultRouteOptions=function(t){var e=t.type,r=i(this[e])?{url:this[e]}:this[e]||{};return r.url=i(r.url)?r.url:"/"+e,r},t.prototype.prepareData=function(t,e){var r,n=t.method;return function(t){t[t.POST=0]="POST",t[t.PUT=1]="PUT",t[t.PATCH=2]="PATCH"}(r||(r={})),n in r?(_(t.data,e),t.data&&!Object.keys(t.data).length&&delete t.data):(_(t.params,t.data,e),delete t.data),t},t.prototype.extractToken=function(t){return a(t,this.tokenPath)},t.extend=o,t}(),T=r(0),b=function(){function t(t,e,r){this.name=this.name||t,this.redirectUri=this.redirectUri||e,this.setDisplayOptions(r)}return t.parseUrl=function(t){var e=document.createElement("a");if(e.href=t,e.search||e.hash){var r=c(e.search.substring(1).replace(/\/$/,"")),n=c(e.hash.substring(1).replace(/[\/$]/,""));return T({},r,n)}throw new Error("OAuth redirect has occurred but no query or hash parameters were found. They were either not set during the redirect, or were removed—typically by a routing library—before Authllizer could read it.")},t.prototype.setDisplayOptions=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.displayOptions=T.apply(void 0,[this.displayOptions].concat(t))},t.extend=o,t}(),C=function(){function t(t){void 0===t&&(t={}),this.key="access_token",this._storage={},T(this,t)}return t.prototype.getToken=function(){var t=this.key;return this._storage[t]},t.prototype.setToken=function(t){var e=this.key;this._storage[e]=t},t.prototype.removeToken=function(){var t=this.key;delete this._storage[t]},t}(),O=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return n(e,t),e.prototype.getToken=function(){try{return localStorage.getItem(this.key)}catch(e){return t.prototype.getToken.call(this)}},e.prototype.setToken=function(e){try{localStorage.setItem(this.key,e.toString())}catch(r){t.prototype.setToken.call(this,e)}},e.prototype.removeToken=function(){try{localStorage.removeItem(this.key)}catch(e){t.prototype.removeToken.call(this)}},e}(C),P=function(){function t(e){this.headerPrefix="Bearer",this._token=String(e),this._payload=t.parse(this._token)}return t.parse=function(t){if(!i(t)||!this.JWT_RX.test(t))throw new Error("Token is invalid or missing.");var e=t.split("."),r=e[1],n=r.replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(d(n))},Object.defineProperty(t.prototype,"expire",{get:function(){var t=this._payload.exp;return new Date(1e3*t)},enumerable:!0,configurable:!0}),t.prototype.getPayload=function(){return this._payload},t.prototype.isExpired=function(){return new Date>this.expire},t.prototype.isValid=function(){return!this.isExpired()},t.prototype.toHeader=function(){return this.headerPrefix+" "+this._token},t.prototype.toString=function(){return this._token},t.prototype.toJSON=function(){return this._payload},t.JWT_RX=/^[A-Za-z0-9-_=]+\.[A-Za-z0-9-_=]+\.?[A-Za-z0-9-_.+\/=]*$/,t}(),A=function(){function t(t){this._client=t}return t.extendUrlQuery=function(t,e){return y(t,e)},t}(),x=function(t,e){return fetch(t,e)},E=function(t){function r(e){return void 0===e&&(e="undefined"!=typeof fetch&&x),t.call(this,e)||this}return n(r,t),r.prototype.request=function(t,n){var o=n.method,i=n.data,s=n.params,a=n.headers,p=void 0===a?{}:a,u=n.withCredentials;t=r.extendUrlQuery(t,s);var c=!0===u&&"include"||!1===u&&"same-origin"||"omit";!p["Content-Type"]&&e(i)&&(p=T({"Content-Type":"application/json"},p),i=JSON.stringify(i));var h={method:o,body:i,credentials:c,headers:p};return this._client(t,h).then(function(t){if(t.ok)return t.json();throw t})},r}(A),U=function(){function t(t){this._options={adapter:w,dialog:S,httpClient:new E,interceptList:[],storage:new O,token:P},this.setOptions(t)}return Object.defineProperty(t.prototype,"adapter",{get:function(){var t=this._options.adapter;if(!f(t))throw new Error("Config: 'adapter' is missing.");return new t(this.httpClient)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dialog",{get:function(){var t=this._options.dialog;if(!f(t))throw new Error("Config: 'dialog' is missing.");return t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"httpClient",{get:function(){var t=this._options.httpClient;if(!e(t))throw new Error("Config: 'httpClient' is missing.");return t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"interceptList",{get:function(){return this._options.interceptList||[]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"storage",{get:function(){var t=this._options.storage;if(!e(t))throw new Error("Config: 'storage' is missing.");return t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"token",{get:function(){var t=this._options.token;if(!f(t))throw new Error("Config: 'token' is missing.");return t},enumerable:!0,configurable:!0}),t.prototype.setOptions=function(t){var r=this;if(e(t)){var n=t.adapter,o=t.dialog,s=t.httpClient,a=t.interceptList,p=t.storage,c=t.token,h=t.providers;if(n){if(!f(n))throw new Error("Config: 'adapter' is invalid.");this._options.adapter=n}if(o){if(!f(o))throw new Error("Config: 'dialog' is  invalid.");this._options.dialog=o}if(s){if(!e(s))throw new Error("Config: 'httpClient' is  invalid.");this._options.httpClient=s}if(a){if(!Array.isArray(a))throw new Error("Config: 'interceptList' is  invalid.");a.forEach(function(t){if(!i(t)&&!l(t))throw new Error("Config: 'interceptList' invalid compere "+t)}),this._options.interceptList=a}if(p){if(!e(p))throw new Error("Config: 'storage' is invalid.");this._options.storage=p}if(c){if(!f(c))throw new Error("Config: 'token' is invalid.");this._options.token=c}if(h){if(!e(h))throw new Error("Config: 'providers' is invalid.");e(this._options.providers)||(this._options.providers={}),u(h,function(t,e){if(!f(t))throw new Error("Config: 'provider' '"+e+"' is invalid.");r._options.providers[e]=t})}}},t.prototype.provider=function(t){var e=this._options.providers;if(!i(t)||!this.isProviderExists(t))throw new Error("Config: '"+t+"' provider is missing.");var r=e[t];if(!f(r))throw new Error("Config: provider should be a class: "+r);return new r(this.adapter,this.dialog)},t.prototype.isProviderExists=function(t){var e=this._options.providers;return!!(void 0===e?{}:e)[t]},t.prototype.isUrlMatchInterceptList=function(t){var e=this.interceptList,r=(e||[]).length;if(!r)return!0;for(var n=0;n<r;n++){var o=e[n];if(i(o)){if(h(t)===h(o))return!0}else if(l(o)&&o.test(t))return!0}return!1},t.Promise="undefined"!=typeof Promise&&Promise||"undefined"!=typeof ES6Promise&&ES6Promise,t}(),j=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return n(r,t),Object.defineProperty(r.prototype,"stringDisplayOptions",{get:function(){return g(this.displayOptions)},enumerable:!0,configurable:!0}),r.prototype.close=function(){this._popup&&e(this._popup)&&f(this._popup.close)&&this._popup.close()},r.prototype.focus=function(){this._popup&&e(this._popup)&&f(this._popup.focus)&&this._popup.focus()},r.prototype.isClosed=function(){return!this._popup||this._popup.closed||void 0===this._popup.closed},r}(b),S=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return n(e,t),Object.defineProperty(e.prototype,"dialogName",{get:function(){return window.navigator.userAgent.indexOf("CriOS")>-1?"_blank":this.name},enumerable:!0,configurable:!0}),e.prototype.setDisplayOptions=function(e){void 0===e&&(e={}),e.height=e.height||500,e.width=e.width||500,t.prototype.setDisplayOptions.call(this,{top:window.screenY+(window.outerHeight-e.height)/2.5,left:window.screenX+(window.outerWidth-e.width)/2},e)},e.prototype.open=function(t){return this._popup=window.open(t,this.dialogName,this.stringDisplayOptions),this.focus(),this.listen().then(function(t){return e.parseUrl(t)})},e.prototype.listen=function(){var t=this;return new U.Promise(function(e,r){var n=h(t.redirectUri,{path:!0}),o=setInterval(function(){if(t.isClosed())return clearInterval(o),r(new Error("The dialog was closed"));try{var i=h(t._popup.location,{path:!0,data:!0});0===i.indexOf(n)&&(t.close(),clearInterval(o),e(i))}catch(t){}},500)})},e}(j),D=function(){function t(t,e){this.redirectUri=window.location.origin,this._adapter=this._adapter||t,this._dialog=this._dialog||e}return t.prototype.openDialog=function(t){var e=this,r=this;return new(0,r._dialog)(r.name,r.redirectUri,r.displayOptions).open(t).then(function(t){return e.checkDialogResponse(t),t})},t.prototype.checkDialogResponse=function(t){if(void 0===t&&(t={}),t.error)throw new Error(t.error)},t.prototype.prepareData=function(t){for(var e=this,r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];var o={},i=T.apply(void 0,r);return u(t,function(t,r){if(r){var n=i[r]||e[r];n&&(o[t]=n)}}),o},t.extend=o,t}(),q=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.requestTokenParams={redirectUri:"callback"},e.authenticateParams={redirectUri:"callback",oauth_token:"oauth_token",oauth_verifier:"oauth_verifier"},e}return n(e,t),e.prototype.authenticate=function(t){var e=this;return this.getRequestToken(t).then(function(r){return e.getPermissions(r).then(function(r){return e.getAccessToken(r,t)})})},e.prototype.getRequestToken=function(t){var e=t.provider,r=t.type,n=t.token,o=this.requestTokenParams,i=this.prepareData(o),s={type:r,data:i,provider:e,token:n};return this._adapter.request(s).then(function(t){return t.response})},e.prototype.getPermissions=function(t){var e=g(t,{delimiter:"&"}),r=[this.authorizationEndpoint,e].join("?");return this.openDialog(r)},e.prototype.getAccessToken=function(t,e){var r=this.authenticateParams,n=this.prepareData(r,t);return e.data=T(n,e.data),this._adapter.request(e)},e}(D),I=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.responseType="code",e.baseDialogParams=["client_id","scope","state","redirect_uri","response_type"],e.authenticateParams={code:"code",clientId:"client_id",redirectUri:"redirect_uri"},e}return n(e,t),Object.defineProperty(e.prototype,"scope",{get:function(){var t=this,e=t.scopeParams,r=void 0===e?[]:e,n=t.scopePrefix,o=t.scopeDelimiter,i=r.join(o);if(""!==i)return n?[n,i].join(o):i},enumerable:!0,configurable:!0}),e.prototype.authenticate=function(t){var e=this;return this.state=this.state||v(),this.getPermissions().then(function(r){return e.getAccessToken(r,t)})},e.prototype.getPermissions=function(){var t=this,e=this,r=e.baseDialogParams,n=e.dialogParams,o=[].concat(r||[],n||[]),i=[];u(o,function(e){var r=k(e),n=t[r];void 0!=n&&i.push(e+"="+n)});var s=i.join("&"),a=[this.authorizationEndpoint,s].join("?");return this.openDialog(a)},e.prototype.getAccessToken=function(t,e){if(this.state&&t.state!==this.state)return U.Promise.reject(new Error("The value returned in the state parameter does not match the state value from your original authorization code request."));if("token"===this.responseType){var r=t.access_token;return U.Promise.resolve({token:r,response:t})}var n=this.authenticateParams,o=this.prepareData(n,t);return e.data=T(o,e.data),this._adapter.request(e)},e}(D),R=function(t){function e(e){return t.call(this,e)||this}return n(e,t),e.prototype.getToken=function(){var e;try{for(var r=document.cookie.split(";"),n=r.length,o=0;o<n;o++){var i=r[o].split("="),s=i[0],a=i[1];if(s.trim()===this.key){e=a;break}}}catch(r){e=t.prototype.getToken.call(this)}return e},e.prototype.setToken=function(t){var e=t.expire||(f(this.expire)?this.expire():this.expire);this._setToken(t,e)},e.prototype.removeToken=function(){this._setToken("",0)},e.prototype._setToken=function(e,r){try{document.cookie=[this.key+"="+e,r?"expires="+new Date(r).toUTCString():"",this.path?"path="+this.path:""].join(";")}catch(r){t.prototype.setToken.call(this,e)}},e}(C),z=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return n(e,t),e.prototype.getToken=function(){try{return sessionStorage.getItem(this.key)}catch(e){return t.prototype.getToken.call(this)}},e.prototype.setToken=function(e){try{sessionStorage.setItem(this.key,e.toString())}catch(r){t.prototype.setToken.call(this,e)}},e.prototype.removeToken=function(){try{sessionStorage.removeItem(this.key)}catch(e){t.prototype.removeToken.call(this)}},e}(C),L=function(){function t(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._listeners=[],this.on.apply(this,t)}return t.prototype.emit=function(t){return u(this._listeners,function(e){e(t)}),this},t.prototype.on=function(){for(var t=this,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return u(e,function(e){f(e)&&t._listeners.push(e)}),this},t.prototype.remove=function(){for(var t=this,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return u(e,function(e){var r=t._listeners.indexOf(e);r>-1&&t._listeners.splice(r,1)}),this},t}(),H=function(){function e(t){if(void 0===t&&(t={}),this._config=new U,this.onChange=new L,!1!==t.useClassInstance)return e.instance.config(t);this.config(t)}return Object.defineProperty(e,"instance",{get:function(){return this.__instance||(this.__instance=new e({useClassInstance:!1})),this.__instance},enumerable:!0,configurable:!0}),e.prototype.config=function(t){return this._config.setOptions(t),this},e.prototype.signIn=function(e){var r=this,n={type:t.AdapterRequestType.signIn,data:e,extractToken:!0};return this._config.adapter.request(n).then(function(t){var e=t.response,n=t.token;return r.setToken(n),e})},e.prototype.signUp=function(e,r){var n=this,o={type:t.AdapterRequestType.signUp,data:e,extractToken:r};return this._config.adapter.request(o).then(function(t){var e=t.response,o=t.token;return r&&n.setToken(o),e})},e.prototype.signOut=function(e){var r=this,n={type:t.AdapterRequestType.signOut,data:e,token:this.getToken()};return this._config.adapter.request(n).then(function(t){var e=t.response;return r.removeToken(),e})},e.prototype.authenticate=function(e,r){var n=this,o={type:t.AdapterRequestType.authenticate,data:r,extractToken:!0,provider:e};return this._config.provider(e).authenticate(o).then(function(t){var e=t.response,r=t.token;return n.setToken(r),e})},e.prototype.link=function(e,r){var n={type:t.AdapterRequestType.link,data:r,token:this.getToken(),provider:e};return this._config.provider(e).authenticate(n).then(function(t){return t.response})},e.prototype.unlink=function(e,r){var n={type:t.AdapterRequestType.unlink,data:T({provider:e},r),token:this.getToken()};return this._config.adapter.request(n).then(function(t){return t.response})},e.prototype.refresh=function(e){var r=this,n={type:t.AdapterRequestType.refresh,data:e,token:this.getToken(),extractToken:!0};return this._config.adapter.request(n).then(function(t){var e=t.token,n=t.response;return r.setToken(e),n})},e.prototype.isAuthenticated=function(){var t=this.getToken();return!!t&&t.isValid()},e.prototype.getToken=function(){var t,e=this._config.storage.getToken(),r=this._config.token;try{t=new r(e)}catch(t){}return t},e.prototype.setToken=function(t){if(i(t)){t=new(0,this._config.token)(t)}this._config.storage.setToken(t),this.onChange.emit(!0)},e.prototype.removeToken=function(){this._config.storage.removeToken(),this.onChange.emit(!1)},e.prototype.toIntercept=function(t){return this.isAuthenticated()&&this._config.isUrlMatchInterceptList(t)},e}(),B=H.instance;t.default=B,t.EventEmitter=L,t.BackendAdapter=w,t.BaseDialog=b,t.BrowserDialog=S,t.PopupDialog=j,t.BaseHttpClient=A,t.FetchHttpClient=E,t.BaseProvider=D,t.OAuth1Provider=q,t.OAuth2Provider=I,t.CookieStorage=R,t.LocalStorage=O,t.MemoryStorage=C,t.SessionStorage=z,t.JWT=P,t.Authllizer=H,t.Config=U,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=authllizer-core.umd.min.js.map